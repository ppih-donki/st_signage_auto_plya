<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Signage Slideshow</title>

  <style>
    html, body {
      margin: 0;
      width: 100%;
      height: 100%;
      background: #fff;
      overflow: hidden;
    }
    #stage {
      position: fixed;
      inset: 0;
      background: #fff;
    }
    .media {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: #fff;
      opacity: 0;
      transition: opacity .5s;
    }
    .media.show {
      opacity: 1;
    }
  </style>
</head>

<body>
<div id="stage"></div>

<script>
const MANIFEST_URL = "manifest.json";
const IMAGE_DEFAULT_MS = 8000;
const AUTO_RELOAD_MS = 10 * 60 * 1000;

const stage = document.getElementById("stage");

let PLAYLIST = [];
let index = 0;
let timer = null;

/* ★ videoは1個だけ */
const video = document.createElement("video");
video.className = "media";
video.muted = true;
video.autoplay = true;
video.playsInline = true;
video.controls = false;
video.preload = "auto";
stage.appendChild(video);

let img = null;

function clearTimer() {
  if (timer) clearTimeout(timer);
  timer = null;
}

function show(el) {
  requestAnimationFrame(() => el.classList.add("show"));
}

function hide(el) {
  if (!el) return;
  el.classList.remove("show");
}

function next() {
  index = (index + 1) % PLAYLIST.length;
  play();
}

async function playImage(src) {
  clearTimer();
  hide(video);

  if (img) img.remove();
  img = document.createElement("img");
  img.src = src;
  img.className = "media";
  stage.appendChild(img);

  await new Promise(r => {
    if (img.complete) return r();
    img.onload = img.onerror = r;
  });

  show(img);
  timer = setTimeout(next, IMAGE_DEFAULT_MS);
}

async function playVideo(src) {
  clearTimer();
  if (img) { img.remove(); img = null; }

  hide(video);
  video.pause();
  video.src = src;
  video.load();

  await new Promise(r => {
    video.onloadedmetadata = r;
    video.onerror = r;
  });

  show(video);
  video.play().catch(()=>{});

  /* ★ onendedは補助 */
  video.onended = next;

  /* ★ メインは duration タイマー */
  if (video.duration && isFinite(video.duration)) {
    timer = setTimeout(next, video.duration * 1000 + 300);
  } else {
    timer = setTimeout(next, 15000); // 保険
  }
}

function play() {
  const item = PLAYLIST[index];
  if (item.type === "image") {
    playImage(item.src);
  } else {
    playVideo(item.src);
  }
}

async function boot() {
  const res = await fetch(MANIFEST_URL, { cache: "no-store" });
  const data = await res.json();

  PLAYLIST = data.files.map(src => ({
    src,
    type: src.match(/\.(mp4|webm)$/i) ? "video" : "image"
  }));

  play();
  setTimeout(() => location.reload(), AUTO_RELOAD_MS);
}

boot();
</script>
</body>
</html>
