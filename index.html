<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <title>Signage Slideshow</title>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: #fff;
      overflow: hidden;
      touch-action: manipulation;
    }
    #stage {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      background: #fff;
    }
    .media {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      background: #fff;
      opacity: 0;
      transition: opacity 600ms ease;
      object-fit: contain;
      object-position: center center;
    }
    .media.show { opacity: 1; }

    #hint {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      background: rgba(0,0,0,0.35);
      color: #fff;
      z-index: 10;
      opacity: 0;
      pointer-events: none;
      transition: opacity .25s;
    }
    #hint.show { opacity: 1; pointer-events: auto; }

    #loading {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      background: #fff;
      color: #000;
      z-index: 20;
    }
    #loading.hidden { display: none; }
  </style>
</head>

<body>
  <div id="stage"></div>
  <div id="loading">読み込み中...</div>

  <div id="hint">
    <div>
      <div style="font-size:18px;font-weight:700;">タップして再生開始</div>
      <button id="startBtn">再生開始</button>
    </div>
  </div>

<script>
const MANIFEST_URL = "manifest.json";
const IMAGE_DEFAULT_MS = 8000;
const AUTO_RELOAD_MS = 10 * 60 * 1000;

const stage = document.getElementById("stage");
const hint = document.getElementById("hint");
const startBtn = document.getElementById("startBtn");
const loading = document.getElementById("loading");

let PLAYLIST = [];
let currentIndex = 0;
let currentEl = null;
let timerId = null;
let started = false;

function clearTimer() {
  if (timerId) clearTimeout(timerId);
  timerId = null;
}

function typeFromSrc(src) {
  return src.match(/\.(mp4|webm)$/i) ? "video" : "image";
}

function makeMediaEl(item) {
  if (item.type === "video") {
    const v = document.createElement("video");
    v.className = "media";
    v.src = item.src;

    /* ★ 修正①：完全ミュート指定（自動再生ブロック回避） */
    v.muted = true;
    v.defaultMuted = true;
    v.volume = 0;
    v.setAttribute("muted", "");
    v.setAttribute("playsinline", "");
    v.setAttribute("webkit-playsinline", "");

    v.controls = false;
    v.loop = false;
    v.preload = "auto";

    return v;
  } else {
    const img = document.createElement("img");
    img.className = "media";
    img.src = item.src;
    return img;
  }
}

function showEl(el) {
  requestAnimationFrame(() => el.classList.add("show"));
}

function hideEl(el) {
  if (!el) return;
  el.classList.remove("show");
  setTimeout(() => el.remove(), 650);
}

async function playItem(index) {
  clearTimer();

  const item = PLAYLIST[index];
  const el = makeMediaEl(item);
  stage.appendChild(el);

  hideEl(currentEl);
  currentEl = el;

  if (item.type === "image") {
    await new Promise(r => el.onload = el.onerror = r);
    showEl(el);
    timerId = setTimeout(goNext, IMAGE_DEFAULT_MS);
    return;
  }

  /* ★ 修正②：load() 明示 */
  el.load();

  await new Promise(resolve => {
    const done = () => resolve();
    el.onloadedmetadata = done;
    el.oncanplay = done;
    el.onerror = done;
    setTimeout(done, 4000); // 無限待ち防止
  });

  showEl(el);

  try {
    await el.play();
  } catch (e) {
    /* ★ 自動再生ブロック時：止まらせて待機 */
    started = false;
    hint.classList.add("show");
    return;
  }

  el.onended = goNext;

  if (el.duration && isFinite(el.duration)) {
    timerId = setTimeout(goNext, el.duration * 1000 + 500);
  }
}

function goNext() {
  currentIndex = (currentIndex + 1) % PLAYLIST.length;
  playItem(currentIndex);
}

function startSlideshow() {
  hint.classList.remove("show");
  started = true;
  playItem(currentIndex);
}

/* ★ 修正③：タップ時は「次へ」より「再生再試行」を優先 */
stage.addEventListener("click", () => {
  if (currentEl && currentEl.tagName === "VIDEO" && currentEl.paused) {
    currentEl.play().then(() => {
      started = true;
      hint.classList.remove("show");
    }).catch(() => {});
    return;
  }
  if (started) goNext();
});

startBtn.onclick = startSlideshow;
hint.onclick = startSlideshow;

async function boot() {
  const res = await fetch(MANIFEST_URL, { cache: "no-store" });
  const data = await res.json();
  PLAYLIST = data.files.map(src => ({ src, type: typeFromSrc(src) }));
  loading.classList.add("hidden");
  startSlideshow();
  setTimeout(() => {
    if (!started) hint.classList.add("show");
  }, 500);
}

setTimeout(() => location.reload(), AUTO_RELOAD_MS);
boot();
</script>
</body>
</html>
