<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <title>Signage Slideshow</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: #fff;
      overflow: hidden;
      touch-action: manipulation;
    }
    #stage {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      background: #fff;
    }
    .media {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      background: #fff;
      opacity: 0;
      transition: opacity 600ms ease;

      object-fit: contain;
      object-position: center center;
    }
    .media.show { opacity: 1; }

    #hint {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      color: #fff;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans JP", sans-serif;
      text-align: center;
      padding: 24px;
      background: rgba(0,0,0,0.35);
      z-index: 10;
      opacity: 0;
      pointer-events: none;
      transition: opacity 250ms ease;
    }
    #hint.show { opacity: 1; pointer-events: auto; }
    #hint .box { max-width: 720px; line-height: 1.6; }
    #hint button {
      margin-top: 14px;
      font-size: 16px;
      padding: 10px 16px;
      border: 0;
      border-radius: 10px;
      background: #fff;
      color: #000;
    }

    #loading {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      color: #000;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans JP", sans-serif;
      text-align: center;
      padding: 24px;
      background: #fff;
      z-index: 20;
      white-space: pre-wrap;
    }
    #loading.hidden { display: none; }
  </style>
</head>
<body>
  <div id="stage" aria-label="signage slideshow"></div>
  <div id="loading">読み込み中...</div>

  <div id="hint">
    <div class="box">
      <div style="font-size:18px;font-weight:700;margin-bottom:6px;">タップして再生開始</div>
      <div style="font-size:14px;opacity:0.9;">
        iOS/Safari は自動再生が制限されます。<br />
        1回タップすると、以降はスライドショーがループします。
      </div>
      <button id="startBtn" type="button">再生開始</button>
    </div>
  </div>

  <script>
    const MANIFEST_URL = "manifest.json";
    const IMAGE_DEFAULT_MS = 8000;
    const FADE_MS = 600;
    const AUTO_RELOAD_MS = 60 * 60 * 1000;

    const stage = document.getElementById("stage");
    const hint = document.getElementById("hint");
    const startBtn = document.getElementById("startBtn");
    const loading = document.getElementById("loading");

    let PLAYLIST = [];
    let currentIndex = 0;
    let currentEl = null;
    let timerId = null;
    let started = false;

    function clearTimer() {
      if (timerId) {
        clearTimeout(timerId);
        timerId = null;
      }
    }

    function extOf(path) {
      const m = String(path).toLowerCase().match(/\.([a-z0-9]+)(\?.*)?$/);
      return m ? m[1] : "";
    }

    function typeFromSrc(src) {
      const ext = extOf(src);
      if (ext === "mp4" || ext === "webm" || ext === "mov") return "video";
      return "image";
    }

    function normalizeSrc(src) {
      const s = String(src || "").trim();
      if (!s) return "";
      if (/^https?:\/\//i.test(s)) return s;
      if (s.startsWith("/")) return s;
      return s;
    }

    function makeMediaEl(item) {
      if (item.type === "video") {
        const v = document.createElement("video");
        v.className = "media";
        v.src = item.src;

        v.muted = true;
        v.defaultMuted = true;
        v.volume = 0;

        v.autoplay = false;
        v.loop = false;
        v.controls = false;
        v.preload = "auto";

        v.playsInline = true;
        v.setAttribute("playsinline", "");
        v.setAttribute("webkit-playsinline", "");

        v.disablePictureInPicture = true;
        v.setAttribute("disablepictureinpicture", "");
        v.controlsList = "nodownload noremoteplayback noplaybackrate";
        v.setAttribute("controlslist", "nodownload noremoteplayback noplaybackrate");

        return v;
      } else {
        const img = document.createElement("img");
        img.className = "media";
        img.src = item.src;
        img.alt = "";
        img.decoding = "async";
        img.loading = "eager";
        return img;
      }
    }

    function showEl(el) {
      requestAnimationFrame(() => el.classList.add("show"));
    }

    function hideAndRemoveEl(el) {
      if (!el) return;
      el.classList.remove("show");
      setTimeout(() => {
        try { el.pause?.(); } catch (_) {}
        if (el && el.parentNode) el.parentNode.removeChild(el);
      }, FADE_MS + 50);
    }

    function showFatal(message) {
      loading.textContent = message;
      loading.classList.remove("hidden");
      hint.classList.add("show");
      started = false;
      clearTimer();
    }

    async function waitImageReady(img) {
      await new Promise((resolve) => {
        if (img.complete) return resolve();
        img.onload = () => resolve();
        img.onerror = () => resolve();
      });
    }

    async function waitVideoReady(v) {
      await new Promise((resolve) => {
        const done = () => resolve();
        v.onloadedmetadata = done;
        v.oncanplay = done;
        v.onerror = done;
      });
    }

    async function playItem(index, fromUserGesture) {
      clearTimer();

      const item = PLAYLIST[index];
      const nextEl = makeMediaEl(item);
      stage.appendChild(nextEl);

      hideAndRemoveEl(currentEl);
      currentEl = nextEl;

      if (item.type === "image") {
        await waitImageReady(nextEl);
        showEl(nextEl);

        const ms = Number.isFinite(item.durationMs) ? item.durationMs : IMAGE_DEFAULT_MS;
        timerId = setTimeout(() => goNext(false), ms);
        return;
      }

      nextEl.load();

      await waitVideoReady(nextEl);
      showEl(nextEl);

      const onVideoError = () => {
        const msg =
          "動画を再生できませんでした。\n\n" +
          "ファイル: " + item.src + "\n\n" +
          "R2/配信側の確認:\n" +
          "・Content-Type が video/mp4 になっているか\n" +
          "・Content-Disposition が attachment になっていないか\n" +
          "・Range(バイト範囲)リクエストが通るか\n";
        showFatal(msg);
      };
      nextEl.onerror = onVideoError;

      try {
        await nextEl.play();
      } catch (e) {
        if (fromUserGesture) {
          onVideoError();
          return;
        }
        started = false;
        hint.classList.add("show");
        return;
      }

      nextEl.onended = () => goNext(false);

      if (Number.isFinite(nextEl.duration) && nextEl.duration > 0) {
        const fallbackMs = Math.ceil(nextEl.duration * 1000) + 500;
        timerId = setTimeout(() => goNext(false), fallbackMs);
      } else {
        timerId = setTimeout(() => goNext(false), 15000);
      }
    }

    function goNext(fromUserGesture) {
      if (!PLAYLIST.length) return;
      currentIndex = (currentIndex + 1) % PLAYLIST.length;
      playItem(currentIndex, !!fromUserGesture);
    }

    function startSlideshow(fromUserGesture) {
      if (!PLAYLIST.length) return;

      loading.classList.add("hidden");
      hint.classList.remove("show");
      started = true;

      playItem(currentIndex, !!fromUserGesture);
    }

    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState !== "visible") return;
      if (!started) return;

      if (currentEl && currentEl.tagName === "VIDEO") {
        currentEl.play().catch(() => {
          started = false;
          hint.classList.add("show");
        });
      }
    });

    async function loadManifest() {
      const res = await fetch(MANIFEST_URL, { cache: "no-store" });
      if (!res.ok) throw new Error("manifest.json を取得できませんでした（HTTP " + res.status + "）");

      const text = await res.text();
      if (!text || !text.trim()) throw new Error("manifest.json が空です（0バイト）");

      let data;
      try {
        data = JSON.parse(text);
      } catch (e) {
        throw new Error("manifest.json がJSONとして壊れています: " + (e?.message || String(e)));
      }

      const files = Array.isArray(data.files) ? data.files : [];
      const items = files
        .map(normalizeSrc)
        .filter(Boolean)
        .map((src) => {
          const t = typeFromSrc(src);
          return {
            src,
            type: t,
            durationMs: t === "image" ? IMAGE_DEFAULT_MS : undefined
          };
        });

      if (!items.length) throw new Error("再生対象が0件です（manifest.json の files が空です）");

      PLAYLIST = items;
      currentIndex = 0;
    }

    function setupAutoReload() {
      setTimeout(() => {
        const url = new URL(location.href);
        url.searchParams.set("_ts", String(Date.now()));
        location.replace(url.toString());
      }, AUTO_RELOAD_MS);
    }

    async function boot() {
      try {
        await loadManifest();
        loading.classList.add("hidden");
        setupAutoReload();

        startSlideshow(false);

        setTimeout(() => {
          if (!started) hint.classList.add("show");
        }, 400);

      } catch (e) {
        loading.textContent =
          "読み込み失敗: " + (e?.message || String(e)) + "\n\n" +
          "確認ポイント:\n" +
          "1) manifest.json が同階層にあるか\n" +
          "2) manifest.json が空でないか\n" +
          "3) files に画像/動画URL(またはパス)が入っているか";
      }
    }

    startBtn.addEventListener("click", (ev) => {
      ev.preventDefault();
      startSlideshow(true);
    });

    hint.addEventListener("click", (ev) => {
      ev.preventDefault();
      startSlideshow(true);
    });

    stage.addEventListener("click", () => {
      if (hint.classList.contains("show")) return;
      goNext(true);
    });

    boot();
  </script>
</body>
</html>